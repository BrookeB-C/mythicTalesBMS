<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layouts/app :: layout($ {'Taproom Operations · ' + (taproom != null ? taproom.name : 'Taproom')}, 'taproom', 'Operate taps, manage keg inventory, and track events for this taproom.', ~{::section[@id='page-content']})}">
<section id="page-content">
  <section class="page-section">
    <div class="card-grid">
      <article class="metric-card">
        <header>
          <h3>Tap handles</h3>
          <span class="metric-pill success" th:text="${tapCount} + ' total'">0 total</span>
        </header>
        <div class="metric-value" th:text="${tapCount}">0</div>
        <footer class="muted">Handles assigned to this taproom.</footer>
      </article>
      <article class="metric-card">
        <header>
          <h3>Active pours</h3>
          <span class="metric-pill warning" th:text="${activeTapHandles} + ' active'">0 active</span>
        </header>
        <div class="metric-value" th:text="${activeTapHandles}">0</div>
        <footer class="muted">Taps currently serving beer.</footer>
      </article>
      <article class="metric-card">
        <header>
          <h3>Available kegs</h3>
          <span class="metric-pill info" th:text="${availableKegCount} + ' on site'">0 on site</span>
        </header>
        <div class="metric-value" th:text="${availableKegCount}">0</div>
        <footer class="muted">Received kegs ready to tap.</footer>
      </article>
      <article class="metric-card">
        <header>
          <h3>Inbound / Blown</h3>
          <span class="metric-pill success" th:text="${inboundKegCount} + ' inbound'">0 inbound</span>
        </header>
        <div class="metric-value" th:text="${blownKegCount}">0</div>
        <footer class="muted">Blown kegs waiting for return.</footer>
      </article>
      <article class="metric-card">
        <header>
          <h3>Recent events</h3>
          <span class="metric-pill success" th:text="${eventsCount} + ' logged'">0 logged</span>
        </header>
        <div class="metric-value" th:text="${eventsCount}">0</div>
        <footer class="muted" th:if="${lastEvent != null}" th:text="${'Last: ' + lastEvent.type + ' @ ' + lastEvent.atTime}">Latest activity</footer>
        <footer class="muted" th:if="${lastEvent == null}">No events recorded yet.</footer>
      </article>
    </div>
  </section>

  <section class="page-section">
    <div class="section-heading">
      <div>
        <h2 th:text="${taproom != null ? taproom.name : 'Taproom'}">Taproom</h2>
        <p class="muted">Manage tap assignments, keg logistics, and team members.</p>
      </div>
      <div class="actions">
        <a class="btn ghost" th:if="${backToBrewery}" th:href="@{/admin/brewery}">Back to brewery</a>
        <a class="btn ghost" th:if="${venue != null}" th:href="@{'/admin/venue/' + ${venue.id}}">Venue Console</a>
        <a class="btn ghost" th:if="${venue != null}" th:href="@{'/taplist?venueId=' + ${venue.id}}">Public taplist</a>
      </div>
    </div>

    <form method="post" th:action="@{/admin/taproom/updateInfo}" class="form-inline">
      <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
      <input type="hidden" name="taproomId" th:value="${taproom != null ? taproom.id : 0}" />
      <div class="form-group">
        <label for="taproomName">Name</label>
        <input id="taproomName" type="text" name="name" th:value="${taproom != null ? taproom.name : ''}" required />
      </div>
      <div class="form-actions">
        <button class="btn primary" type="submit">Save</button>
      </div>
    </form>

    <div class="tabs">
      <a th:href="@{/admin/taproom(tab='taplist', taproomId=${taproom != null ? taproom.id : null})}"
         th:classappend="${tab == null or tab == 'taplist'} ? ' active' : ''">Taplist</a>
      <a th:href="@{/admin/taproom(tab='kegs', taproomId=${taproom != null ? taproom.id : null})}"
         th:classappend="${tab == 'kegs'} ? ' active' : ''">Kegs</a>
      <a th:href="@{/admin/taproom(tab='inbound', taproomId=${taproom != null ? taproom.id : null})}"
         th:classappend="${tab == 'inbound'} ? ' active' : ''">Inbound</a>
      <a th:href="@{/admin/taproom(tab='blown', taproomId=${taproom != null ? taproom.id : null})}"
         th:classappend="${tab == 'blown'} ? ' active' : ''">Blown</a>
      <a th:href="@{/admin/taproom(tab='events', taproomId=${taproom != null ? taproom.id : null})}"
         th:classappend="${tab == 'events'} ? ' active' : ''">Events</a>
      <a th:href="@{/admin/taproom(tab='users', taproomId=${taproom != null ? taproom.id : null})}"
         th:classappend="${tab == 'users'} ? ' active' : ''">Users</a>
    </div>
  </section>

  <section class="page-section" id="taplistSection" th:if="${tab == null or tab == 'taplist'}">
    <div class="section-heading">
      <div>
        <h3>Taplist</h3>
        <p class="muted">Pour, blow, or retap directly from the bar.</p>
      </div>
    </div>
    <div class="table-wrapper">
      <table class="table">
        <thead>
        <tr><th>Tap</th><th>Beer</th><th>Status</th><th>Actions</th></tr>
        </thead>
        <tbody>
        <tr th:each="t : ${taps}" th:attr="id=${'tap-row-' + t.id}">
          <td th:text="${t.number}">1</td>
          <td>
            <span th:if="${t.keg != null}">
              <strong th:text="${t.keg.beer.name}">Beer</strong>
              <span class="muted" th:text="${' · ' + t.keg.beer.style + ' · ' + t.keg.beer.abv + '% ABV'}"></span>
            </span>
            <span th:if="${t.keg == null}" class="muted">Empty</span>
          </td>
          <td>
            <div th:if="${t.keg != null}" class="fillbar">
              <div class="fill" th:style="${'width:' + t.keg.fillPercent + '%'}"></div>
            </div>
            <span class="muted" th:text="${t.keg != null ? t.keg.fillPercent + '%' : '-'}">%</span>
          </td>
          <td>
            <div th:if="${t.keg != null}" class="actions">
              <form method="post"
                    th:action="@{'/taps/' + ${t.id} + '/pour'}"
                    class="form-inline form-inline--compact ajax-form"
                    th:attr="data-tap-id=${t.id}">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                <input type="hidden" name="redirect" th:value="@{|/admin/taproom?taproomId=${taproom != null ? taproom.id : 0}&from=brewery&tab=taplist|}" />
                <input type="hidden" name="tapId" th:value="${t.id}" />
                <div class="form-group">
                  <label class="sr-only" th:for="${'pour-' + t.id}">Pour ounces</label>
                  <select th:id="${'pour-' + t.id}" name="ounces">
                    <option value="4">4 oz</option>
                    <option value="8">8 oz</option>
                    <option value="12">12 oz</option>
                    <option value="16" selected>16 oz</option>
                    <option value="20">20 oz</option>
                  </select>
                </div>
                <div class="form-actions">
                  <button class="btn secondary" type="submit">Pour</button>
                  <button class="btn critical outline" type="submit" th:formaction="@{'/taps/' + ${t.id} + '/blow'}">Blow</button>
                </div>
              </form>
            </div>
            <div th:if="${t.keg == null}" class="actions">
              <form method="post"
                    th:action="@{'/taps/' + ${t.id} + '/tapKeg'}"
                    class="form-inline form-inline--compact ajax-form"
                    th:attr="data-tap-id=${t.id}">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                <input type="hidden" name="redirect" th:value="@{|/admin/taproom?taproomId=${taproom != null ? taproom.id : 0}&from=brewery&tab=taplist|}" />
                <input type="hidden" name="tapId" th:value="${t.id}" />
                <div class="form-group">
                  <label class="sr-only" th:for="${'keg-' + t.id}">Select keg</label>
                  <select th:id="${'keg-' + t.id}" name="kegId" required>
                    <option value="" disabled selected>Select untapped keg…</option>
                    <option th:each="k : ${availableKegs}" th:value="${k.id}"
                            th:text="${k.beer.name + ' — ' + k.size + ' — ' + k.fillPercent + '%'}">Keg</option>
                  </select>
                </div>
                <div class="form-actions">
                  <button class="btn primary" type="submit">Tap keg</button>
                </div>
              </form>
            </div>
          </td>
        </tr>
        </tbody>
      </table>
    </div>
  </section>

  <section class="page-section" th:if="${tab == 'kegs'}">
    <div class="section-heading">
      <div>
        <h3>Available kegs</h3>
        <p class="muted">Received inventory staged for tapping.</p>
      </div>
    </div>
    <div class="filter-chip-row">
      <span class="muted">Status:</span>
      <a th:href="@{/admin/taproom(tab='kegs', taproomId=${taproom != null ? taproom.id : null})}"
         th:classappend="${selectedStatus == null} ? ' filter-chip active' : ' filter-chip'">RECEIVED</a>
      <a th:each="s : ${allStatuses}"
         th:href="@{/admin/taproom(tab='kegs', status=${s}, taproomId=${taproom != null ? taproom.id : null})}"
         th:text="${s}"
         th:classappend="${selectedStatus == s} ? ' filter-chip active' : ' filter-chip'">STATUS</a>
    </div>
    <ul class="inventory-list">
      <li th:each="k : ${kegs}">
        <div>
          <strong th:text="${k.serialNumber}">SER-001</strong>
          <span class="muted" th:text="${' · ' + k.beer.name + ' · ' + k.size}"></span>
        </div>
        <span class="badge" th:classappend="${k.status == T(com.mythictales.bms.taplist.domain.KegStatus).FILLED} ? ' green' :
                                     (k.status == T(com.mythictales.bms.taplist.domain.KegStatus).DISTRIBUTED ? ' blue' :
                                     (k.status == T(com.mythictales.bms.taplist.domain.KegStatus).RECEIVED ? ' purple' :
                                     (k.status == T(com.mythictales.bms.taplist.domain.KegStatus).TAPPED ? ' orange' :
                                     (k.status == T(com.mythictales.bms.taplist.domain.KegStatus).BLOWN ? ' red' : ' gray'))))"
              th:text="${k.status}">STATUS</span>
      </li>
      <li th:if="${#lists.isEmpty(kegs)}" class="muted">No kegs match the selected status.</li>
    </ul>
  </section>

  <section class="page-section" th:if="${tab == 'inbound'}">
    <div class="section-heading">
      <div>
        <h3>Inbound kegs</h3>
        <p class="muted">DISTRIBUTED kegs awaiting receipt.</p>
      </div>
    </div>
    <ul class="inventory-list">
      <li th:each="k : ${inboundKegs}">
        <div>
          <strong th:text="${k.serialNumber}">SER-002</strong>
          <span class="muted" th:text="${' · ' + k.beer.name + ' · ' + k.size}"></span>
        </div>
        <form method="post" th:action="@{'/admin/taproom/kegs/' + ${k.id} + '/receive'}" class="form-inline form-inline--compact">
          <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
          <div class="form-actions">
            <button class="btn secondary" type="submit">Mark received</button>
          </div>
        </form>
      </li>
      <li th:if="${#lists.isEmpty(inboundKegs)}" class="muted">No inbound kegs right now.</li>
    </ul>
  </section>

  <section class="page-section" th:if="${tab == 'blown'}">
    <div class="section-heading">
      <div>
        <h3>Blown kegs</h3>
        <p class="muted">Ready for return to the brewery.</p>
      </div>
    </div>
    <ul class="inventory-list">
      <li th:each="k : ${blownKegs}">
        <div>
          <strong th:text="${k.serialNumber}">SER-003</strong>
          <span class="muted" th:text="${' · ' + k.beer.name + ' · ' + k.size}"></span>
        </div>
        <form method="post" th:action="@{'/admin/taproom/kegs/' + ${k.id} + '/return'}" class="form-inline form-inline--compact">
          <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
          <div class="form-actions">
            <button class="btn secondary" type="submit">Return to brewery</button>
          </div>
        </form>
      </li>
      <li th:if="${#lists.isEmpty(blownKegs)}" class="muted">No blown kegs waiting for pickup.</li>
    </ul>
  </section>

  <section class="page-section" th:if="${tab == 'users'}">
    <div class="section-heading">
      <div>
        <h3>Taproom users</h3>
        <p class="muted">Roles scoped to this taproom.</p>
      </div>
    </div>
    <div class="alert" th:if="${errorMessage != null}" th:text="${errorMessage}"></div>
    <div class="alert success-alert" th:if="${successMessage != null}" th:text="${successMessage}"></div>

    <form class="form-grid" method="post" th:action="@{/admin/taproom/users}">
      <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
      <input type="hidden" name="taproomId" th:value="${taproom != null ? taproom.id : null}" />
      <input type="hidden" name="from" th:value="${backToBrewery} ? 'brewery' : null" />
      <div class="form-group">
        <label for="taproom-username">Username</label>
        <input id="taproom-username" name="username" type="text" required />
      </div>
      <div class="form-group">
        <label for="taproom-password">Password</label>
        <input id="taproom-password" name="password" type="password" required />
      </div>
      <div class="form-group">
        <label for="taproom-role">Role</label>
        <select id="taproom-role" name="role">
          <option th:each="r : ${taproomUserRoles}" th:value="${r}" th:text="${#strings.replace(r.name(),'_',' ')}"></option>
        </select>
      </div>
      <div class="form-actions">
        <button class="btn primary" type="submit">Create user</button>
      </div>
    </form>

    <div class="table-wrapper">
      <table class="table">
        <thead>
        <tr><th>Username</th><th>Role</th><th>Actions</th></tr>
        </thead>
        <tbody>
        <tr th:each="u : ${taproomUsers}">
          <td th:text="${u.username}">user</td>
          <td th:text="${#strings.replace(u.role,'ROLE_','')}">role</td>
          <td class="actions">
            <form method="post" th:action="@{'/admin/taproom/users/' + ${u.id} + '/delete'}">
              <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
              <input type="hidden" name="taproomId" th:value="${taproom != null ? taproom.id : null}" />
              <input type="hidden" name="from" th:value="${backToBrewery} ? 'brewery' : null" />
              <button class="btn ghost" type="submit">Remove</button>
            </form>
          </td>
        </tr>
        <tr th:if="${#lists.isEmpty(taproomUsers)}">
          <td class="muted" colspan="3">No users assigned to this taproom.</td>
        </tr>
        </tbody>
      </table>
    </div>
  </section>

  <section class="page-section" th:if="${tab == 'events'}">
    <div class="section-heading">
      <div>
        <h3>Event log</h3>
        <p class="muted">Review pours, blows, and maintenance activity.</p>
      </div>
    </div>
    <div class="alert" th:if="${#lists.isEmpty(events)}">No events recorded.</div>
    <div class="table-wrapper" th:if="${!#lists.isEmpty(events)}">
      <table class="table">
        <thead>
        <tr><th>Time</th><th>Tap</th><th>Event</th><th>Ounces</th><th>Beer</th><th>Keg</th><th>By</th></tr>
        </thead>
        <tbody>
        <tr th:each="e : ${events}">
          <td th:text="${e.atTime}">2025-01-01T00:00:00Z</td>
          <td th:text="${e.placement.tap.number}">1</td>
          <td><span class="badge blue" th:text="${e.type}">POUR</span></td>
          <td th:text="${e.ounces} ?: '-'">16</td>
          <td th:text="${e.placement.keg.beer.name}">IPA</td>
          <td th:text="${e.placement.keg.id}">42</td>
          <td th:text="${e.actor != null ? e.actor.username : '—'}">—</td>
        </tr>
        </tbody>
      </table>
    </div>
  </section>
</section>

<script>
  (function () {
    function ajaxify(form) {
      form.addEventListener('submit', function (e) {
        e.preventDefault();
        var fd = new FormData(form);
        var target = (e.submitter && e.submitter.getAttribute('formaction')) || form.getAttribute('action') || window.location.href;
        var tapId = form.getAttribute('data-tap-id') || fd.get('tapId');
        fetch(target, {
          method: 'POST',
          credentials: 'same-origin',
          headers: { 'X-Requested-With': 'XMLHttpRequest' },
          body: new URLSearchParams(fd)
        })
          .then(function () {
            var url = new URL(window.location.href);
            url.searchParams.set('tab', 'taplist');
            return fetch(url.toString(), { credentials: 'same-origin' }).then(function (res) {
              return res.text();
            });
          })
          .then(function (html) {
            var tmp = document.createElement('div');
            tmp.innerHTML = html;
            if (tapId) {
              var srcRow = tmp.querySelector('#tap-row-' + tapId);
              var dstRow = document.querySelector('#tap-row-' + tapId);
              if (srcRow && dstRow) {
                dstRow.innerHTML = srcRow.innerHTML;
                attachAjax();
                return;
              }
            }
            var src = tmp.querySelector('#taplistSection');
            var dst = document.querySelector('#taplistSection');
            if (src && dst) {
              dst.innerHTML = src.innerHTML;
              attachAjax();
            }
          })
          .catch(function (err) {
            console.error('Update failed', err);
          });
      });
    }
    function attachAjax() {
      document.querySelectorAll('form.ajax-form').forEach(ajaxify);
    }
    attachAjax();
  })();
</script>
</html>
