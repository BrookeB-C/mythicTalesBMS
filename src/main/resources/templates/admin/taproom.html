
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head><meta charset="UTF-8"/><title>Taproom Admin</title><link rel="stylesheet" th:href="@{/css/app.css}"/></head>
<body>
<header>
  <h1>Taproom Admin</h1>
  <div class="badge" style="display:inline-block;margin-left:0.5rem;padding:0.15rem 0.4rem;border-radius:6px;background:#eef3ff;color:#2a4b8d;font-size:0.85rem;vertical-align:middle;">
    <span th:if="${lastEvent != null}">
      Last event: <strong th:text="${lastEvent.type}">TAP</strong>
      <span th:text="'@ ' + ${lastEvent.atTime}">@ time</span>
    </span>
    <span th:if="${lastEvent == null}">No events yet</span>
  </div>
</header>
<main>
  <!-- Info section -->
  <section>
    <h2 th:text="${taproom != null ? 'Taproom: ' + taproom.name : 'Taproom'}">Taproom</h2>
    <form method="post" th:action="@{/admin/taproom/updateInfo}" class="inline">
      <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
      <input type="hidden" name="taproomId" th:value="${taproom != null ? taproom.id : 0}"/>
      <label>Name <input type="text" name="name" th:value="${taproom != null ? taproom.name : ''}"/></label>
      <button class="btn" type="submit">Save</button>
    </form>
    <a class="btn ghost" th:if="${backToBrewery}" th:href="@{/admin/brewery}" style="margin-left:.5rem">⟵ Back to Brewery Admin</a>
  </section>
  <p><a href="/taplist">Go to Taplist</a></p>

  <!-- Tabs -->
  <div class="tabs">
    <a th:classappend="${(tab == null or tab == 'taplist') ? ' active' : ''}"
       th:href="@{/admin/taproom(tab='taplist')}">Taplist</a>
    <a th:classappend="${(tab == 'kegs') ? ' active' : ''}"
       th:href="@{/admin/taproom(tab='kegs')}">Kegs</a>
    <a th:classappend="${(tab == 'inbound') ? ' active' : ''}"
       th:href="@{/admin/taproom(tab='inbound')}">Inbound Kegs</a>
    <a th:classappend="${(tab == 'blown') ? ' active' : ''}"
       th:href="@{/admin/taproom(tab='blown')}">Blown Kegs</a>
    <a th:classappend="${(tab == 'events') ? ' active' : ''}"
       th:href="@{/admin/taproom(tab='events')}">Events</a>
    <a th:classappend="${(tab == 'users') ? ' active' : ''}"
       th:href="@{/admin/taproom(tab='users')}">Users</a>
  </div>

  <!-- Taplist (same table as taplist page) -->
  <section th:if="${tab == null or tab == 'taplist'}" id="taplistSection">
    <h2>Your Taplist</h2>
    <table class="table">
      <thead>
        <tr><th>Tap #</th><th>Beer</th><th>Status</th><th>Actions</th></tr>
      </thead>
      <tbody>
        <tr th:each="t : ${taps}"
            th:attr="id=${'tap-row-' + t.id}">
          <td th:text="${t.number}">1</td>
          <td>
            <span th:if="${t.keg != null}">
              <strong th:text="${t.keg.beer.name}">Beer</strong>
              <span class="muted"> (</span><span class="muted" th:text="${t.keg.beer.style}">Style</span>
              <span class="muted">, </span><span class="muted" th:text="${t.keg.beer.abv}">5.0</span><span class="muted">% ABV)</span>
            </span>
            <span th:if="${t.keg == null}"><em class="muted">Empty</em></span>
          </td>
          <td>
            <div th:if="${t.keg != null}">
              <div class="pintwrap" style="margin-top:.4rem;">
                <div th:with="p=${t.keg.fillPercent}, top=10, bottom=80, gh=${bottom - top}, bh=${T(java.lang.Math).round(gh * p / 100.0)}, by=${bottom - bh}, clipId=${'clip' + t.id}, showFoam=${p >= 95}"
                     th:classappend="${p <= 10} ? ' low' : null">
                  <svg class="pint" width="60" height="90" viewBox="0 0 60 90" aria-label="Fill level">
                    <defs>
                      <clipPath th:attr="id=${clipId}">
                        <path d="M 18 10 L 42 10 L 38 80 L 22 80 Z"></path>
                      </clipPath>
                      <linearGradient id="beerGrad" x1="0%" y1="0%" x2="0%" y2="100%">
                        <stop offset="0%" stop-color="#ffe08a"/>
                        <stop offset="100%" stop-color="#c6862b"/>
                      </linearGradient>
                    </defs>
                    <rect x="16" width="28" th:attr="y=${by},height=${bh},clip-path=|url(#${clipId})|" fill="url(#beerGrad)"></rect>
                    <rect x="16" width="28" th:if="${showFoam}" th:attr="y=${top},height=6,clip-path=|url(#${clipId})|" fill="#ffffff" opacity="0.9"></rect>
                    <path class="pintglass" d="M 18 10 L 42 10 L 38 80 L 22 80 Z" fill="none" stroke="#8aa3bf" stroke-width="2" th:classappend="${p <= 10} ? ' low' : null"></path>
                  </svg>
                  <div class="debug-tooltip">
                    <span th:text="|${p}% — ${t.keg.remainingOunces} oz (${t.keg.size})|">%</span>
                  </div>
                </div>
              </div>
            </div>
          </td>
          <td>
            <div th:if="${t.keg != null}" class="actions">
              <form method="post" th:action="@{'/taps/' + ${t.id} + '/pour'}" class="inline ajax-form"
                    th:attr="data-tap-id=${t.id}">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                <input type="hidden" name="redirect" th:value="@{|/admin/taproom?taproomId=${taproom != null ? taproom.id : 0}&from=brewery&tab=taplist|}"/>
                <input type="hidden" name="tapId" th:value="${t.id}"/>
                <label class="inline">Pour
                  <select name="ounces">
                    <option value="4">4 oz</option>
                    <option value="8">8 oz</option>
                    <option value="12">12 oz</option>
                    <option value="16" selected>16 oz</option>
                    <option value="20">20 oz</option>
                  </select>
                </label>
                <button class="btn" type="submit">Pour</button>
                <button class="btn danger" type="submit" th:formaction="@{'/taps/' + ${t.id} + '/blow'}">Blow</button>
              </form>
            </div>
            <div th:if="${t.keg == null}" class="actions">
              <form method="post" th:action="@{'/taps/' + ${t.id} + '/tapKeg'}" class="inline ajax-form"
                    th:attr="data-tap-id=${t.id}">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                <input type="hidden" name="redirect" th:value="@{|/admin/taproom?taproomId=${taproom != null ? taproom.id : 0}&from=brewery&tab=taplist|}"/>
                <input type="hidden" name="tapId" th:value="${t.id}"/>
                <label class="inline">Keg
                  <select name="kegId" required>
                    <option value="" disabled selected>Select untapped keg…</option>
                    <option th:each="k : ${availableKegs}" th:value="${k.id}"
                            th:text="${k.beer.name} + ' — ' + ${k.size} + ' — ' + ${k.fillPercent} + '%'">Keg</option>
                  </select>
                </label>
                <button class="btn" type="submit">Tap Keg</button>
              </form>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
  </section>

  <!-- Kegs -->
  <section th:if="${tab == 'kegs'}">
    <h2>Available Kegs (Received)</h2>
    <div class="filters">
      <span>Status:</span>
      <a th:href="@{/admin/taproom(tab='kegs')}" th:classappend="${(selectedStatus == null) ? ' chip active' : ' chip'}">All</a>
      <a th:each="s : ${allStatuses}"
         th:href="@{/admin/taproom(tab='kegs', status=${s})}"
         th:text="${s}"
         th:classappend="${(selectedStatus == s) ? ' chip active' : ' chip'}">RECEIVED</a>
    </div>
    <ul>
      <li th:each="k : ${kegs}">
        <span th:text="${k.serialNumber}">SER-001</span>:
        <span th:text="${k.beer.name}">Beer</span>
        — <span th:text="${k.size}">HALF_BARREL</span>
        — <span class="badge" th:text="${k.status}"
                th:classappend="${(k.status == T(com.mythictales.bms.taplist.domain.KegStatus).FILLED) ? ' green' :
                                (k.status == T(com.mythictales.bms.taplist.domain.KegStatus).DISTRIBUTED ? ' blue' :
                                (k.status == T(com.mythictales.bms.taplist.domain.KegStatus).RECEIVED ? ' purple' :
                                (k.status == T(com.mythictales.bms.taplist.domain.KegStatus).TAPPED ? ' orange' :
                                (k.status == T(com.mythictales.bms.taplist.domain.KegStatus).BLOWN ? ' red' : ' gray'))))}">
          </span>
      </li>
    </ul>

  </section>

  <!-- Inbound Kegs -->
  <section th:if="${tab == 'inbound'}">
    <h2>Inbound Kegs (Awaiting Receipt)</h2>
    <ul>
      <li th:each="k : ${inboundKegs}">
        <span th:text="${k.serialNumber}">SER-002</span>:
        <span th:text="${k.beer.name}">Beer</span> — <span th:text="${k.size}">HALF_BARREL</span>
        <form method="post" th:action="@{'/admin/taproom/kegs/' + ${k.id} + '/receive'}" class="inline" style="margin-left:0.5rem;">
          <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
          <button class="btn" type="submit">Receive</button>
        </form>
      </li>
    </ul>
  </section>

  <!-- Blown Kegs -->
  <section th:if="${tab == 'blown'}">
    <h2>Blown Kegs (Ready to Return)</h2>
    <ul>
      <li th:each="k : ${blownKegs}">
        <span th:text="${k.serialNumber}">SER-003</span>:
        <span th:text="${k.beer.name}">Beer</span> — <span th:text="${k.size}">HALF_BARREL</span>
        <form method="post" th:action="@{'/admin/taproom/kegs/' + ${k.id} + '/return'}" class="inline" style="margin-left:0.5rem;">
          <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
          <button class="btn" type="submit">Return to Brewery</button>
        </form>
      </li>
    </ul>
  </section>

  <!-- Users -->
  <section th:if="${tab == 'users'}">
    <h2>Users</h2>
    <table class="table">
      <thead>
        <tr><th>Username</th><th>Role</th></tr>
      </thead>
      <tbody>
        <tr th:each="u : ${taproomUsers}">
          <td th:text="${u.username}">user</td>
          <td th:text="${u.role}">role</td>
        </tr>
      </tbody>
    </table>
  </section>

  <!-- Events -->
  <section th:if="${tab == 'events'}">
    <h2>Events</h2>
    <div class="alert muted" th:if="${#lists.isEmpty(events)}">No events yet.</div>
    <table class="table" th:if="${!#lists.isEmpty(events)}">
      <thead>
      <tr>
        <th>Time</th>
        <th>Tap</th>
        <th>Event</th>
        <th>Ounces</th>
        <th>Beer</th>
        <th>Keg</th>
        <th>By</th>
      </tr>
      </thead>
      <tbody>
      <tr th:each="e : ${events}">
        <td th:text="${e.atTime}">2025-01-01T00:00:00Z</td>
        <td th:text="${e.placement.tap.number}">1</td>
        <td th:text="${e.type}">POUR</td>
        <td th:text="${e.ounces} ?: '-'">16</td>
        <td th:text="${e.placement.keg.beer.name}">IPA</td>
        <td th:text="${e.placement.keg.id}">42</td>
        <td th:text="${e.actor != null ? e.actor.username : '—'}">—</td>
      </tr>
      </tbody>
    </table>
  </section>
</main>
    <div th:replace="~{fragments/footer :: footer}"></div>
<script>
  (function(){
    function ajaxify(form){
      form.addEventListener('submit', function(e){
        e.preventDefault();
        var fd = new FormData(form);
        var target = (e.submitter && e.submitter.getAttribute('formaction')) || form.getAttribute('action') || window.location.href;
        var tapId = form.getAttribute('data-tap-id') || fd.get('tapId');
        fetch(target, {
          method: 'POST',
          credentials: 'same-origin',
          headers: { 'X-Requested-With': 'XMLHttpRequest' },
          body: new URLSearchParams(fd)
        }).then(function(){
          // Refresh only the affected row if possible, else whole taplist section
          var url = new URL(window.location.href);
          url.searchParams.set('tab','taplist');
          return fetch(url.toString(), { credentials: 'same-origin' })
            .then(function(res){ return res.text(); })
            .then(function(html){
              var tmp = document.createElement('div');
              tmp.innerHTML = html;
              if (tapId) {
                var srcRow = tmp.querySelector('#tap-row-' + tapId);
                var dstRow = document.querySelector('#tap-row-' + tapId);
                if (srcRow && dstRow) {
                  dstRow.innerHTML = srcRow.innerHTML;
                  attachAjax();
                  return;
                }
              }
              // fallback: replace taplist section
              var src = tmp.querySelector('#taplistSection');
              var dst = document.querySelector('#taplistSection');
              if (src && dst) { dst.innerHTML = src.innerHTML; attachAjax(); }
            });
          .catch(function(err){ console.error('Update failed', err); });
      });
    }
    function attachAjax(){
      document.querySelectorAll('form.ajax-form').forEach(ajaxify);
    }
    attachAjax();
  })();
</script>
</body></html>
