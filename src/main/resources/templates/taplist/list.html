<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8"/>
  <title>Taplist</title>
  <link rel="stylesheet" th:href="@{/css/app.css}"/>
</head>
<body>
<header class="container"><h1>Taplist</h1></header>
<main class="container">
  <table class="table">
    <thead>
      <tr><th>Tap #</th><th>Beer</th><th>Status</th><th>Actions</th></tr>
    </thead>
    <tbody>
      <tr th:each="t : ${taps}">
        <td th:text="${t.number}">1</td>
        <td>
          <span th:if="${t.keg != null}">
            <strong th:text="${t.keg.beer.name}">Beer</strong>
            <span class="muted"> (</span><span class="muted" th:text="${t.keg.beer.style}">Style</span>
            <span class="muted">, </span><span class="muted" th:text="${t.keg.beer.abv}">5.0</span><span class="muted">% ABV)</span>
          </span>
          <span th:if="${t.keg == null}"><em class="muted">Empty</em></span>
        </td>
        <td>
          <!-- Only render indicators when a keg exists. No references to t.keg.* outside this block. -->
          <div th:if="${t.keg != null}">
            <div class="pintwrap" style="margin-top:.4rem;">
              <div th:with="p=${t.keg.fillPercent},
                            top=10, bottom=80,
                            gh=${bottom - top},
                            bh=${T(java.lang.Math).round(gh * p / 100.0)},
                            by=${bottom - bh},
                            clipId=${'clip' + t.id},
                            showFoam=${p >= 95}"
                   th:classappend="${p <= 10} ? ' low' : null">
                <svg class="pint" width="60" height="90" viewBox="0 0 60 90" aria-label="Fill level">
                  <defs>
                    <clipPath th:attr="id=${clipId}">
                      <path d="M 18 10 L 42 10 L 38 80 L 22 80 Z"></path>
                    </clipPath>
                    <linearGradient id="beerGrad" x1="0%" y1="0%" x2="0%" y2="100%">
                      <stop offset="0%" stop-color="#ffe08a"/>
                      <stop offset="100%" stop-color="#c6862b"/>
                    </linearGradient>
                  </defs>

                  <!-- Beer fill, clipped to glass -->
                  <rect x="16" width="28"
                        th:attr="y=${by},height=${bh},clip-path=|url(#${clipId})|"
                        fill="url(#beerGrad)"></rect>

                  <!-- Foam head when near full -->
                  <rect x="16" width="28" th:if="${showFoam}"
                        th:attr="y=${top},height=6,clip-path=|url(#${clipId})|"
                        fill="#ffffff" opacity="0.9"></rect>

                  <!-- Glass outline -->
                  <path class="pintglass"
                        d="M 18 10 L 42 10 L 38 80 L 22 80 Z"
                        fill="none" stroke="#8aa3bf" stroke-width="2"
                        th:classappend="${p <= 10} ? ' low' : null"></path>
                </svg>

                <!-- Tooltip with debug info (appears on hover) -->
                <div class="debug-tooltip">
                  <span th:text="|${p}% — ${t.keg.remainingOunces} oz (${t.keg.size})|">%</span>
                </div>
              </div>
            </div>
          </div>
        </td>
        <td>
          <div th:if="${t.keg != null}" class="actions">
            <form method="post" th:action="@{'/taps/' + ${t.id} + '/pour'}" class="inline">
              <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
              <label class="inline">Pour
                <select name="ounces">
                  <option value="4">4 oz</option>
                  <option value="8">8 oz</option>
                  <option value="12">12 oz</option>
                  <option value="16" selected>16 oz</option>
                  <option value="20">20 oz</option>
                </select>
              </label>
              <button class="btn" type="submit">Pour</button>
              <button class="btn danger" type="submit" th:formaction="@{'/taps/' + ${t.id} + '/blow'}">Blow</button>
            </form>
          </div>
          <div th:if="${t.keg == null}" class="actions">
            <form method="post" th:action="@{'/taps/' + ${t.id} + '/tapKeg'}" class="inline">
              <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
              <label class="inline">Keg
                <select name="kegId" required>
                  <option value="" disabled selected>Select untapped keg…</option>
                  <option th:each="k : ${availableKegs}" th:value="${k.id}"
                          th:text="${k.beer.name} + ' — ' + ${k.size} + ' — ' + ${k.fillPercent} + '%'">Keg</option>
                </select>
              </label>
              <button class="btn" type="submit">Tap Keg</button>
            </form>
          </div>
        </td>
      </tr>
    </tbody>
  </table>
</main>
<div th:replace="fragments/footer :: footer"></div>
</body>
</html>
